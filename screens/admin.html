<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles.css">
  <title>Admin Page</title>
</head>
<body>
  <header class="header">
    <nav class="nav">
      <a href="/feed.html" class="nav-link">Feed</a>
      <a href="/admin.html" class="nav-link" id="admin-link">Admin</a>
      <a href="/search.html" class="nav-link">Search</a>
      <a href="#" class="nav-link" id="logout-link">Logout</a>
    </nav>
  </header>

  <main class="main-content">
    <h2>Admin Panel</h2>
    
    <h3>User Activity</h3>
    <ul id="activity-list"></ul>
    
    <h3>Enable/Disable Features</h3>
    <div>
      <label>
        <input type="checkbox" id="feed-feature" />
        Feed
      </label>
      <label>
        <input type="checkbox" id="search-feature" />
        Search
      </label>
    </div>
    <button id="update-features">Update Features</button>
    
    <h3>Remove Users</h3>
    <form id="delete-users-form">
      <ul id="user-list"></ul>
      <button type="submit">Delete Selected Users</button>
    </form>
  </main>

  <script>
    const activityList = document.getElementById('activity-list');
    const feedFeature = document.getElementById('feed-feature');
    const searchFeature = document.getElementById('search-feature');
    const updateFeaturesButton = document.getElementById('update-features');
    const userList = document.getElementById('user-list');

    // Function to fetch user activity
    async function fetchUserActivity() {
      try {
        const response = await fetch('/admin/activity', {
          method: 'GET',
        });
        const activity = await response.json();

        if (response.ok) {
          activityList.innerHTML = activity.map(user => `
        <li>
          <strong>${user.username}</strong>: <br>
          activity: <br>
          ${user.activityHistory.map(event => `
            ${event.event.charAt(0).toUpperCase() + event.event.slice(1)}: ${event.timestamp}<br>
          `).join('')}
          <br>
          Posts: ${user.posts.length} <br><br>
        </li>
      `).join('');
        } else {
          console.error(activity.error);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Function to fetch user list
    async function fetchUserList() {
      try {
        const response = await fetch('/admin/users', {
          method: 'GET',
        });
        console.log("res", response);
        const users = await response.json();
        console.log("users", users);
        if (response.ok) {
          userList.innerHTML = users.map(user => `
        <li>
          <input type="checkbox" name="user" value="${user.username}">
          <strong>${user.username}</strong>
        </li>
      `).join('');
        } else {
          console.error(users.error);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Function to update enabled features
    async function updateFeatures() {
      const features = {
        feed: feedFeature.checked,
        search: searchFeature.checked,
      };

      try {
        const response = await fetch('/admin/features', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(features),
        });

        const data = await response.json();
        if (response.ok) {
          console.log(data.message);
        } else {
          console.error(data.error);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    fetchUserActivity();
    fetchUserList();

    updateFeaturesButton.addEventListener('click', updateFeatures);

    //logout
    const logoutLink = document.getElementById('logout-link');

    logoutLink.addEventListener('click', async (event) => {
      event.preventDefault();

      try {
        const response = await fetch('/logout', {
          method: 'POST',
        });
        console.info('res', response);
        const data = await response.json();
        if (response.ok) {
          // Redirect to the login page or perform other actions
          window.location.href = '/login.html';
          console.log(data.message);
        } else {
          console.error(data.error);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    });

    const deleteUsersForm = document.getElementById('delete-users-form');

    deleteUsersForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      const selectedUsers = Array.from(deleteUsersForm.querySelectorAll('input[name="user"]:checked'))
              .map(input => input.value);

      if (selectedUsers.length === 0) {
        console.log("No users selected to delete.");
        return;
      }

      try {
        const response = await fetch('/admin/users/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ usersToDelete: selectedUsers }),
        });

        const data = await response.json();
        if (response.ok) {
          console.log(data.message);
          fetchUserList(); // Update the user list after deletion
        } else {
          console.error(data.error);
        }
      } catch (error) {
        console.error('Error:', error);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      const adminLink = document.getElementById('admin-link');
      const cookies = document.cookie.split(';').map(cookie => cookie.trim().split('='));
      const sessionCookie = cookies.find(cookie => cookie[0] === 'session');
      decodedValue = decodeURIComponent(sessionCookie[1]);
      if (!sessionCookie || decodedValue !== 'j:{"username":"admin"}') {
        adminLink.style.display = 'none';
      }
    });
  </script>
</body>
</html>
